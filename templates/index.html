<!-- HMC-UI v2 -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Human Mind Compiler ‚Äî Chat</title>
  <style>
    :root { --bg:#0f1226; --panel:#15183a; --bubble-user:#2962ff; --bubble-bot:#21264d; --accent:#7c4dff;
            --text:#e6e8ff; --muted:#9aa0c3; --danger:#ff5370; --ok:#00c853; }
    * { box-sizing: border-box; }
    body { margin:0; background:linear-gradient(135deg,#0f1226 0%,#1a1f4a 100%); color:var(--text); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .wrap { max-width:900px; margin:0 auto; min-height:100dvh; display:flex; flex-direction:column; }
    header { padding:18px 16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #242857; backdrop-filter:blur(6px); position:sticky; top:0; background:rgba(10,12,28,.6);}
    header .dot { width:12px; height:12px; border-radius:50%; background:var(--ok); box-shadow:0 0 12px var(--ok); }
    header h1 { font-size:18px; margin:0; letter-spacing:.3px; }
    header span { color:var(--muted); font-size:13px; }
    .chat { flex:1; padding:20px 16px 8px; display:flex; flex-direction:column; gap:14px; overflow:auto; }
    .msg { display:flex; }
    .msg.user { justify-content:flex-end; }
    .msg.assistant { justify-content:flex-start; }
    .msg.error { justify-content:center; }
    .bubble { max-width:78%; padding:12px 14px; border-radius:14px; box-shadow:0 4px 20px rgba(0,0,0,.25); white-space:pre-wrap; word-wrap:break-word; }
    .user .bubble { background:var(--bubble-user); color:#fff; border-top-right-radius:6px; }
    .assistant .bubble { background:var(--bubble-bot); color:var(--text); border-top-left-radius:6px; }
    .error .bubble { background:#3a1e28; color:#ffcdd2; border:1px solid #c62828; }
    .typing { display:flex; align-items:center; gap:8px; color:var(--muted); font-size:13px; padding:0 4px 8px; }
    .blink { width:6px; height:6px; border-radius:50%; background:var(--muted); animation:blink 1s infinite; }
    @keyframes blink { 0%,100%{opacity:.25} 50%{opacity:1} }
    .composer { position:sticky; bottom:0; padding:12px; background:linear-gradient(0deg, rgba(10,12,28,.85) 0%, rgba(10,12,28,.6) 100%); border-top:1px solid #242857; }
    .bar { display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:end; background:var(--panel); border:1px solid #242857; border-radius:14px; padding:10px; }
    textarea { width:100%; resize:none; border:0; outline:0; background:transparent; color:var(--text); max-height:180px; height:50px; font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    button { height:44px; padding:0 14px; border:1px solid #2a2f63; border-radius:12px; background:#1e2350; color:#e6e8ff; cursor:pointer; }
    button:hover { filter:brightness(1.06); }
    .send { background:linear-gradient(135deg,#5f5fff,#7c4dff); border-color:transparent; }
    .mic.listening { border-color:#00e5ff; box-shadow:0 0 0 2px rgba(0,229,255,.2) inset; }
    .hint { margin-top:8px; color:var(--muted); font-size:12px; }
    code.kbd { background:#11142c; padding:2px 6px; border-radius:6px; border:1px solid #232656; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="dot"></div>
      <h1>Human Mind Compiler ‚Äî Chat</h1>
      <span>Enter envia ‚Ä¢ Shift+Enter quebra linha ‚Ä¢ üéôÔ∏è reconhecimento de voz</span>
    </header>

    <main id="chat" class="chat" aria-live="polite" aria-label="Mensagens do chat"></main>
    <div class="typing" id="typing" style="display:none;">
      <div class="blink"></div><div class="blink"></div><div class="blink"></div>
      <span>digitando‚Ä¶</span>
    </div>

    <div class="composer">
      <div class="bar">
        <textarea id="input" placeholder="Digite sua mensagem..."></textarea>
        <button id="micBtn" class="mic" title="Falar (Web Speech API)">üéôÔ∏è</button>
        <button id="sendBtn" class="send">Enviar</button>
      </div>
      <div class="hint">Dica: pressione <code class="kbd">Enter</code> para enviar e <code class="kbd">Shift</code>+<code class="kbd">Enter</code> para nova linha.</div>
    </div>
  </div>

  <script>
    // ---- Helpers ----
    const chatEl  = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const typingEl= document.getElementById('typing');
    const micBtn  = document.getElementById('micBtn');
    const API_CHAT = '/chat';

    function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function appendMessage(role, text){
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = escapeHtml(text).replace(/\n/g,'<br>');
      div.appendChild(bubble);
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function setTyping(on){ typingEl.style.display = on ? 'flex' : 'none'; }

    // ---- PATCH: resposta JSON robusta (mostra corpo bruto se n√£o for JSON) ----
    async function sendMessage(){
      const text = inputEl.value.trim();
      if (!text) return;
      appendMessage('user', text);
      inputEl.value = '';
      setTyping(true);

      try {
        const res = await fetch(API_CHAT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });

        const raw = await res.text(); // pode ser JSON ou HTML de erro
        let data;
        try {
          data = JSON.parse(raw);
        } catch {
          throw new Error('Resposta inv√°lida do servidor: ' + raw.slice(0, 400));
        }

        if (!res.ok || !data.success) {
          const msg = (data && data.error) ? data.error : (res.status + ' ' + res.statusText);
          throw new Error(msg);
        }

        appendMessage('assistant', data.reply || '');
      } catch (err) {
        appendMessage('error', 'Falha ao enviar /chat: ' + err.message);
      } finally {
        setTyping(false);
        inputEl.focus();
      }
    }

    // Enter envia (Shift+Enter = quebra linha)
    inputEl.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.addEventListener('click', sendMessage);

    // ---- Reconhecimento de voz (Web Speech API) ----
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null, listening = false;

    function toggleListen(){
      if (!SpeechRecognition) {
        appendMessage('error','Reconhecimento de voz n√£o suportado neste navegador.');
        return;
      }
      if (!rec) {
        rec = new SpeechRecognition();
        rec.lang = 'pt-BR'; // ajuste: 'en-US' | 'es-ES' | 'zh-CN'
        rec.interimResults = true;
        rec.continuous = false;
        rec.maxAlternatives = 1;

        rec.onstart = ()=>{ listening = true; micBtn.classList.add('listening'); };
        rec.onend   = ()=>{ listening = false; micBtn.classList.remove('listening'); };
        rec.onerror = (e)=>{ appendMessage('error','Voz: ' + (e.error || 'erro desconhecido')); };

        rec.onresult = (e)=>{
          let finalTranscript = '';
          for (let i = e.resultIndex; i < e.results.length; i++) {
            const t = e.results[i][0].transcript;
            if (e.results[i].isFinal) finalTranscript += t;
          }
          if (finalTranscript) {
            inputEl.value = (inputEl.value + ' ' + finalTranscript).trim();
            inputEl.focus();
          }
        };
      }
      if (!listening) rec.start(); else rec.stop();
    }

    micBtn.addEventListener('click', toggleListen);

    // Mensagem inicial
    appendMessage('assistant','Ol√°! Envie sua primeira mensagem. (Dica: use Enter para enviar; üéôÔ∏è para ditar.)');
  </script>
</body>
</html>
