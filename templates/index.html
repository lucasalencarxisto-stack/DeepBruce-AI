<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <title>OpenAI Chat (SSE)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}" />
  </head>
  <body>
    <header class="header">
      <div class="logo">ü§ñ</div>
      <div class="title">OpenAI Chat ‚Äì SSE</div>
    </header>

    <main class="container">
      <div class="controls">
        <select id="flow">
          <option value="two-step">Flow 1: POST /chat + GET /stream</option>
          <option value="single">Flow 2: POST /stream2 (single endpoint)</option>
        </select>
        <button id="reset">Reset</button>
      </div>

      <div id="chat" class="chat"></div>

      <form id="form" class="composer">
        <textarea id="msg" rows="3" placeholder="Digite sua mensagem / Type your message..."></textarea>
        <button id="send" class="primary" type="submit">Enviar</button>
      </form>
    </main>

    <script>
      /*
      PT-BR: Renderizador Markdown leve: **negrito**, _it√°lico_, `inline code`, ```blocos```.
      EN:    Lightweight Markdown: **bold**, _italic_, `inline code`, ```blocks```.
      ES:    Markdown ligero: **negrita**, _cursiva_, `c√≥digo`, ```bloques```.
      ‰∏≠Êñá:   ËΩªÈáè MarkdownÔºö**Á≤ó‰Ωì**„ÄÅ_Êñú‰Ωì_„ÄÅ`Ë°åÂÜÖ‰ª£Á†Å`„ÄÅ```‰ª£Á†ÅÂùó```„ÄÇ
      */
      function md(s) {
        s = s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        s = s.replace(/```([\s\S]*?)```/g, (m, code) => `<pre><code>${code.trim()}</code></pre>`);
        s = s.replace(/`([^`]+)`/g, (m, code) => `<code>${code}</code>`);
        s = s.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        s = s.replace(/_([^_]+)_/g, "<em>$1</em>");
        s = s.replace(/\n/g, "<br>");
        return s;
      }

      const chat = document.getElementById("chat");
      const form = document.getElementById("form");
      const msgInput = document.getElementById("msg");
      const sendBtn = document.getElementById("send");
      const resetBtn = document.getElementById("reset");
      const flowSel = document.getElementById("flow");

      let es = null; // PT-BR: EventSource ativo (flow 1) / EN: active EventSource

      function append(role, text) {
        const div = document.createElement("div");
        div.className = `msg ${role}`;
        div.innerHTML = `<div class="role">${role}</div><div class="bubble">${md(text)}</div>`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      async function sendTwoStep(message) {
        sendBtn.disabled = true;
        append("user", message);

        const resp = await fetch("/chat", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({message}),
        });
        if (!resp.ok) { append("error", "Falha ao enviar /chat"); sendBtn.disabled = false; return; }

        es = new EventSource("/stream");
        const assistantDiv = document.createElement("div");
        assistantDiv.className = "msg assistant";
        assistantDiv.innerHTML = `<div class="role">assistant</div><div class="bubble"></div>`;
        chat.appendChild(assistantDiv);
        const bubble = assistantDiv.querySelector(".bubble");

        es.addEventListener("ping", () => {});
        es.addEventListener("done", () => { append("system", "[END]"); es.close(); es = null; sendBtn.disabled = false; });
        es.addEventListener("error", () => { append("error", "[ERROR]"); es && es.close(); es = null; sendBtn.disabled = false; });
        es.onmessage = (ev) => { if (ev.data) bubble.innerHTML += md(ev.data); chat.scrollTop = chat.scrollHeight; };
      }

      async function sendSingle(message) {
        sendBtn.disabled = true;
        append("user", message);

        const resp = await fetch("/stream2", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({message}),
        });
        if (!resp.ok) { append("error", "Falha ao abrir /stream2"); sendBtn.disabled = false; return; }

        const assistantDiv = document.createElement("div");
        assistantDiv.className = "msg assistant";
        assistantDiv.innerHTML = `<div class="role">assistant</div><div class="bubble"></div>`;
        chat.appendChild(assistantDiv);
        const bubble = assistantDiv.querySelector(".bubble");

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        (async function read() {
          try {
            const { value, done } = await reader.read();
            if (done) { sendBtn.disabled = false; return; }
            buffer += decoder.decode(value, { stream: true });
            const parts = buffer.split("\n\n"); buffer = parts.pop();
            for (const part of parts) {
              const lines = part.split("\n");
              let event = null, data = [];
              for (const line of lines) {
                if (line.startsWith("event:")) event = line.slice(6).trim();
                else if (line.startsWith("data:")) data.push(line.slice(5).trim());
              }
              const payload = data.join("\n");
              if (event === "ping") continue;
              if (event === "error") append("error", payload || "[ERROR]");
              else if (event === "done") append("system", "[END]");
              else bubble.innerHTML += md(payload);
            }
            read();
          } catch (e) {
            append("error", "Stream interrompido: " + e);
            sendBtn.disabled = false;
          }
        })();
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = msgInput.value.trim();
        if (!message) return;
        msgInput.value = "";
        if (flowSel.value === "two-step") sendTwoStep(message);
        else sendSingle(message);
      });

      resetBtn.addEventListener("click", async () => {
        await fetch("/reset", { method: "POST" });
        chat.innerHTML = "";
        append("system", "Sess√£o reiniciada / Session reset / Sesi√≥n reiniciada / ‰ºöËØùÂ∑≤ÈáçÁΩÆ");
      });
    </script>
  </body>
</html>
