<!doctype html>
<meta charset="utf-8" />
<title>portifolio-chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  body { margin: 0; background: #0b1220; color: #e6edf3; }
  .wrap { max-width: 800px; margin: 40px auto; padding: 16px; }
  .card { background: #0f172a; border: 1px solid #1f2a44; border-radius: 16px; padding: 16px; }
  .row { display: flex; gap: 8px; }
  textarea { flex: 1; min-height: 90px; padding: 10px; border-radius: 10px;
             border: 1px solid #334155; background:#0b1220; color:#e6edf3; }
  button { padding: 10px 14px; border-radius: 10px; border: 1px solid #334155;
           background:#172554; color:#e6edf3; cursor: pointer; }
  button:hover { background:#1e3a8a; }
  .log { white-space: pre-wrap; background:#0b1220; border:1px dashed #334155; border-radius: 10px; padding: 10px; min-height: 160px; }
  .muted { color:#9aa4b2; }
</style>

<div class="wrap">
  <h1>portifolio-chat</h1>
  <div class="card">
    <div class="row">
      <textarea id="msg" placeholder="Escreva sua mensagem..."></textarea>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="send">Enviar (JSON)</button>
      <button id="stream">Streaming</button>
      <span id="status" class="muted" style="margin-left:auto"></span>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="log" id="out"></div>
  </div>

  <p class="muted" style="margin-top:10px">
    Dica: o botão <b>Streaming</b> mostra tokens em tempo real. O servidor envia <code>:preamble</code> e <code>:hb</code>.
  </p>
</div>

<script>
const out = document.getElementById('out');
const msg = document.getElementById('msg');
const statusEl = document.getElementById('status');

function print(line) {
  out.textContent += line;
  out.scrollTop = out.scrollHeight;
}
function println(line="") { print(line + "\n"); }

async function sendJSON() {
  const text = msg.value.trim();
  if (!text) return;
  statusEl.textContent = "enviando...";
  out.textContent = "";

  const res = await fetch("/chat", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ message: text })
  });
  const data = await res.json();
  println("provider: " + data.provider);
  println(data.reply);
  statusEl.textContent = "";
}

async function sendStream() {
  const text = msg.value.trim();
  if (!text) return;
  statusEl.textContent = "streaming...";
  out.textContent = "";

  const res = await fetch("/chat?model=llama3.2:3b&num_predict=128", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ message: text, stream: true })
  });

  if (!res.body) {
    println("[erro] streaming não suportado no browser?");
    statusEl.textContent = "";
    return;
  }

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buf = "";
  while (true) {
    const {value, done} = await reader.read();
    if (done) break;
    buf += decoder.decode(value, {stream:true});
    const lines = buf.split("\n");
    buf = lines.pop();
    for (const line of lines) {
      if (!line) continue;
      if (line.startsWith(":")) continue; // ignora preamble/heartbeats
      print(line);
    }
  }
  statusEl.textContent = "";
}

document.getElementById('send').onclick = sendJSON;
document.getElementById('stream').onclick = sendStream;
</script>
